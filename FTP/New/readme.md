Few modifications and based on tcp code
